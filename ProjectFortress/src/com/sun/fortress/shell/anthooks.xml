<?xml version="1.0" ?>

  <!-- Copyright 2006 Sun Microsystems, Inc., 
       4150 Network Circle, Santa Clara, California 95054, U.S.A. 
       All rights reserved.

      U.S. Government Rights - Commercial software. 
      Government users are subject to the Sun Microsystems, Inc. standard 
      license agreement and applicable provisions of the FAR and its supplements.
 
      Use is subject to license terms.

      This distribution may include materials developed by third parties.

      Sun, Sun Microsystems, the Sun logo and Java are trademarks or registered 
      trademarks of Sun Microsystems, Inc. in the U.S. and other countries. -->

<project name="Fortress" basedir=".."> 
  <!-- basedir is at the top of the fortress, one level up. -->
  <description>
    Ant targets defined as hooks for use by the fortress shell.
    When building a fortress, this script is copied into a build.xml
    file for internal use by the new fortress.
  </description>
  
  <property name="binLoc" location="${basedir}/bin"/>

  <target name="extract"
	  description="Extract a distribution from a jar file at a deployment site.">
    <unjar src="${jarLoc}"
	   dest="${fortressLoc}/Fortress" />
    <chmod file="${fortressLoc}/Fortress/bin/fortress" perm="a+x"/>
    <echo message="Fortress extracted to ${fortressLoc}."/>
  </target>
   
  <target name="compile"
	  description="Compile the given source file and install the resulting components into the fortress.">
    <exec dir="${binLoc}" executable="fortress.run" output="${componentName}">
      <arg line="parse ${sourcefile}"/>
    </exec>
  </target>
      
  <target name="installer" 
	  description="build a new installer as a jar">
    <delete dir="${installerDir}"/>
    <mkdir dir="${installerDir}/fortress"/>
    <copy todir="${installerDir}/fortress/FORTRESS">
      <fileset dir="FORTRESS"/>    
    </copy>
    <copy todir="${installerDir}/fortress/bin">
      <fileset dir="bin"/>
    </copy>
    <copy file="docs/installer/README.txt" todir="${installerDir}/fortress"/>
    <tar destfile="fortress.tar.gz"
	 basedir="${installerDir}"
	 longfile="fail"
	 compression="gzip"/>
    <delete dir="${installerDir}"/>
  </target>

  <target name="prep.selfupgrade"
	  description="Upgrade this fortress with the given tar file.">
    <delete dir=".selfupgrade"/>
    <mkdir dir=".selfupgrade"/>
    <untar src="${tarfile}" dest=".selfupgrade" compression="gzip"/>
    <copy todir="lib">
      <fileset dir=".selfupgrade/lib">
	<include name="*.jar"/>
	<include name="*.xml"/>
      </fileset>
    </copy>
    <copy todir="test">
      <fileset dir=".selfupgrade/test">
	<include name="*"/>
      </fileset>
    </copy>
    <copy todir="bin">
      <fileset dir=".selfupgrade/bin">
	<include name="*"/>
      </fileset>
    </copy>
    <condition property="run.jarfile">
      <available file="lib/selfupgrade.jar"/>
    </condition>
    <delete dir=".selfupgrade"/>
  </target>
  
  <target name="selfupgrade" if="run.jarfile" depends="prep.selfupgrade">
    <java jar="lib/selfupgrade.jar"/>
  </target>

</project>